name: singularity-build

on:
  push:
    tags:
      - '*'


permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: Setup Go 1.13
        uses: actions/setup-go@v5
        with:
          go-version: '1.13'

      - name: Setup Singularity
        uses: eWaterCycle/setup-singularity@v7
        with:
          singularity-version: 3.8.3

      - name: Get changed .singularity files since last tag
        id: diff
        run: |
          # 現在のタグ名
          CURRENT_TAG="${GITHUB_REF##*/}"

          # 直近2つのタグを取得（新しい順）
          TAGS=($(git tag --sort=-creatordate | head -n 2))

          if [ "${#TAGS[@]}" -lt 2 ]; then
            echo "No previous tag to diff against"
            echo "changed_files=" >> $GITHUB_OUTPUT
            exit 0
          fi

          PREV_TAG=${TAGS[1]}
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREV_TAG"

          CHANGED_FILES=$(git diff --name-only "$PREV_TAG" "$CURRENT_TAG" | grep '\.singularity$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No .singularity files changed"
            echo "changed_files=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed .singularity files:"
          echo "$CHANGED_FILES"
          echo "changed_files=$(echo $CHANGED_FILES | tr '\n' ' ')" >> $GITHUB_OUTPUT


      - name: Build changed .singularity files
        id: build-sif
        if: steps.diff.outputs.changed_files != ''
        run: |
          for FILE in ${{ steps.diff.outputs.changed_files }}; do
            BASENAME="${FILE%.singularity}"
            SIF="${BASENAME}.sif"
            echo "Building $SIF from $FILE"
            singularity build --fakeroot "$SIF" "$FILE"
            SIF_LIST="$SIF_LIST $SIF"
          done

          echo "sif_list=$SIF_LIST" >> $GITHUB_OUTPUT
          
          #       - name: Find and build all .singularity files
          #         id: build-sif
          #         run: |
          #           FILES=(`git diff HEAD^ --name-only|tr '\n' ' ' `)
          #           for FILE in ${FILES[@]}; do
          #             BASENAME="${FILE%.singularity}"
          #             SIF="${BASENAME}.sif"
          #             echo "Building $SIF from $FILE"
          #             singularity build "$SIF" "$FILE"
          #             SIF_LIST="$SIF_LIST $SIF"
          #           done
          # 
          #           if [ -z "$SIF_LIST" ]; then
          #             echo "No .singularity files changed"
          #             exit 0
          #           fi
          # 
          #           echo "sif_list=$SIF_LIST" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.build-sif.outputs.sif_list != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: ${{ steps.build-sif.outputs.sif_list }}
